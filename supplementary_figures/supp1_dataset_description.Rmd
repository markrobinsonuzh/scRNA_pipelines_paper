---
title: "Supplementary Figures 1-x"
author: "Pierre-Luc Germain"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r, include=FALSE}
if(!exists('FIG_NB')){
  FIG_NB <- 0
  getFigNb <- function(increment=FALSE){
    if(increment) FIG_NB <<- FIG_NB + 1
    FIG_NB
  }
}
```

```{r}
suppressPackageStartupMessages({
  library(ggplot2)
  library(cowplot)
  library(SingleCellExperiment)
  library(scater)
  library(reshape2)
  library(pheatmap)
})
suppressMessages(devtools::load_all("../../pipComp/"))

# we load the datasets
lf <- list.files("../datasets/", full.names=TRUE)
names(lf) <- gsub(".SCE.rds", "", basename(lf), fixed=TRUE)
SCEs <- lapply(lf, readRDS)
```

# Supplementary Figure `r getFigNb(TRUE)`

```{r dist_cell_properties, fig.width=8.5, fig.height=8.5}
vars <- c( "log10(features)"="log10_total_features", "log10(counts)"="log10_total_counts", 
           "% in top 20"="pct_counts_in_top_20_features", "% mito"="pct_counts_Mt", 
           "% ribosomal"="pct_counts_ribosomal", "% coding"="pct_counts_coding" )
plot_grid(plotlist=lapply(1:length(vars), FUN=function(x){ 
  p <- plotFilters(SCEs, vars[x], nmads=c(2,5), ncol=1) + xlab(names(vars)[x])
  p <- p + scale_y_continuous(breaks=scales::pretty_breaks(2))
  p <- p + scale_x_continuous(breaks=scales::pretty_breaks(3))
  p + theme( axis.title.y = element_blank(), 
             strip.text.x = element_text(size=10),
             axis.title=element_text(size=11),
             axis.text=element_text(size=11) )
}), nrow=1)
```

### Supplementary Figure `r getFigNb()`
Distribution across cells of various control properties in the different datasets. The 
lines indicate respectively 2 and 5 median absolute deviations (MADs).

\newpage


# Supplementary Figure `r getFigNb(TRUE)`

```{r mixology_doublet_featcount, fig.height=4}
plotDoublets <- function(sce, title="", mads=c(2,2.5,3), vars=c("log10_total_features", "log10_total_counts")){
  cd <- as.data.frame(colData(sce))
  p <- ggplot(cd, aes_string(x=vars[1], y=vars[2], colour="demuxlet_cls")) + geom_point()
  p <- p + geom_point(data=cd[which(cd$demuxlet_cls=="DBL"),], size=3)
  lt <- c("solid","dashed","dotted","dotdash")
  for(i in 1:length(mads)){
    th <- .tmads(cd[[vars[1]]], mads[i])[2]
    p <- p + geom_vline(aes_string(xintercept=th), linetype=lt[i])
    th <- .tmads(cd[[vars[2]]], mads[i])[2]
    p <- p + geom_hline(aes_string(yintercept=th), linetype=lt[i])
  }
  p  
}
pl <- list( plotDoublets(SCEs$mixology10x3cl) + ggtitle("mixology10x3cl"),
            plotDoublets(SCEs$mixology10x5cl) + ggtitle("mixology10x5cl") )
plot_grid(plotlist=pl, labels=LETTERS[1:2])
```

### Supplementary Figure `r getFigNb()`
The total counts and total features per cell of doublets versus other cells. We used the demuxlet annotation of doublets (based on SNPs) made available through CellBench. While doublets tend to have a higher total count and especially number of detected features, these features alone are not always sufficient for their identification.


\newpage

# Supplementary Figure `r getFigNb(TRUE)`
[to come]
### Supplementary Figure `r getFigNb()`
Doublets that cannot be identified by our method show lower signs of being doublets.

\newpage


# Supplementary Figure `r getFigNb(TRUE)`

```{r featcount_ratio}
d <- data.frame( dataset=rep(names(SCEs),sapply(SCEs,ncol)), 
                 log10_counts=unlist(lapply(SCEs,FUN=function(x) x$log10_total_counts)),
                 log10_features=unlist(lapply(SCEs,FUN=function(x) x$log10_total_features)),
                 featcount_dist=unlist(lapply(SCEs,FUN=function(x) x$featcount_dist)))
ggplot(d, aes(x=log10_features, y=log10_counts, colour=featcount_dist)) + geom_point() + facet_wrap(~dataset, scale="free") + scale_colour_gradient2(limits=c(-0.2,0.2))
```

### Supplementary Figure `r getFigNb()`
There is a tight relationship, in 10x datasets (i.e. not the `Koh` and `Kumar` datasets), between the total counts of a cell and its number of detected features. We therefore include, among control variables, deviation from this ratio.

