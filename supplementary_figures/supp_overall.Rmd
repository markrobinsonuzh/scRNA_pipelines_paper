---
title: "Supplementary Figures relative to feature selection"
author: "Pierre-Luc Germain"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r, include=FALSE}
if(!exists('FIG_NB')){
  FIG_NB <- 0
  getFigNb <- function(increment=FALSE){
    if(increment) FIG_NB <<- FIG_NB + 1
    FIG_NB
  }
}

suppressPackageStartupMessages({
  library(ggplot2)
  library(cowplot)
  library(ComplexHeatmap)
  library(pipeComp)
})
theme_set(theme_cowplot(font_size = 11))
source("../misc_functions.R")
```

# Supplementary Figure `r getFigNb(TRUE)`

```{r, fig.width=7, fig.height=6}
ov <- readRDS("../data/overall.rds")

cl <- ov$evaluation$clustering
cl$norm <- relevel(cl$norm, "norm.seurat")
cl$doubletmethod <- relevel(cl$doubletmethod, "none")
cl$filt <- relevel(cl$filt, "none")
cl$sel <- relevel(cl$sel, "sel.vst")
cl$clustmethod <- relevel(cl$clustmethod, "clust.seurat")
cl$clustmethod <- relevel(cl$clustmethod, "clust.seurat")

ff <- function(x, trueK=FALSE){
  f <- paste0(x,"~dataset+resolution*dataset+doubletmethod+filt+norm+clustmethod+dims")
  if(trueK) cl <- cl[cl$n_clus==cl$true.nbClusts,]
  mod <- lm(as.formula(f), data=cl)
  co <- as.data.frame(coef(summary(mod)))
  co <- co[grep("sctransfrom|scran|filt|elbow|doublet|Annoy", row.names(co)),]
  colnames(co)[2:4] <- c("stderr","t","pvalue")
  co$coef <- gsub(" +$","",row.names(co))
  aov <- as.data.frame(summary(aov(mod))[[1]])[,-1]
  aov <- aov[grep("^Residuals|resolution|dataset", row.names(aov), invert=TRUE),]
  aov$varExpl <- aov[,1]/sum(aov[,1])
  aov <- aov[grep("^Residuals", row.names(aov), invert=TRUE),4:5]
  colnames(aov)[1] <- "pvalue"
  aov$parameter <- gsub(" +$","",row.names(aov))
  list( coefs=co, aov=aov )
}

cos <- lapply(c(MI="MI",ARI="ARI",minPre="min_pr"), FUN=ff)
aov <- dplyr::bind_rows(lapply(cos, FUN=function(x) x$aov), .id="metric")

cos2 <- lapply(c(ARI="ARI"), trueK=TRUE, FUN=ff)
aov2 <- dplyr::bind_rows(lapply(cos2, FUN=function(x) x$aov), .id="metric")
p1 <- ggplot(aov, aes(reorder(parameter, -varExpl), varExpl, group=parameter, fill=metric)) + 
  geom_col() + xlab("") + ylab("Proportion of variance explained") + coord_flip()
p2 <- ggplot(aov2, aes(reorder(parameter, -varExpl), varExpl, group=parameter, fill=metric)) + 
  geom_col() + xlab("") + ylab("Variance explained") + theme(legend.position="none") + 
  coord_flip() + ggtitle("ARI at true k")

co <- dplyr::bind_rows(lapply(cos, FUN=function(x) x$coef), .id="metric")
co2 <- dplyr::bind_rows(lapply(cos2, FUN=function(x) x$coef), .id="metric")
for(f in c("norm","filt","doubletmethod","dims","clustmethod")){
  co$coef <- gsub(paste0("^",f),"",co$coef)
  co2$coef <- gsub(paste0("^",f),"",co2$coef)
}
p3 <- ggplot(co, aes(coef, Estimate, group=coef, fill=metric)) + geom_col() + xlab("") +
  ylab("Estimated coefficient") + geom_hline(yintercept = 0, linetype="dashed") + 
  coord_flip() + theme(legend.position="none")
p4 <- ggplot(co2, aes(coef, Estimate, group=coef, fill=metric)) + geom_col() + xlab("") +
  ylab("Estimated coefficient") + geom_hline(yintercept = 0, linetype="dashed") + 
  coord_flip() + theme(legend.position="none")

# plot_grid( plot_grid(p1,p2,rel_widths=c(4,3),labels=LETTERS[1:2]),
#            plot_grid(p3,p4,rel_widths=c(4,3),labels=LETTERS[3:4]),
#            nrow=2, rel_heights=c(3,4))
plot_grid(p1 + ylab("Proportion of variance in metric explained by the parameter"),p2,nrow=2,labels=LETTERS[1:2])
```

### Supplementary Figure `r getFigNb()`

**A:** Proportion of the variance in clustering accuracy metrics explained by main parameters. **B:** Proportion of the variance in Adjusted Rand Index (ARI) explained by the parameters, among the analyses giving the true number of clusters. In both panels, the proportion is calculated after accounting for differences due to the dataset, the resolution and their interaction.


\newpage

# Supplementary Figure `r getFigNb(TRUE)`

```{r}
rnfn <- function(x){
  x <- gsub("^norm\\.","",x)
  x <- gsub("^doublet\\.","",x)
  x <- gsub("> none > ","> no filter > ",x)
  gsub("^none > ","",x)
}

H1 <- renameHrows( scrna_evalPlot_silh(ov, agg.by = c("doubletmethod","filt","norm"), row_split = norm,
                                       heatmap_legend_param=list(direction="horizontal"),font_factor = 0.8,
                                       row_names_max_width=unit(7, "cm")), rnfn)
H2 <- renameHrows(
     evalHeatmap(ov, step="clustering", what=c("MI","min_pr"), anno_legend=FALSE, title=c("MI","Min precision"), 
                 agg.by=c("doubletmethod","filt","norm"), font_factor = 0.8, 
                 row_split=norm,row_names_max_width=unit(7, "cm")) + 
    evalHeatmap(ov, step="clustering", what=c("ARI"), agg.by=c("doubletmethod","filt","norm"), 
                row_split=norm,filter=n_clus==true.nbClusts, title="ARI at true k",
                anno_legend=FALSE, font_factor = 0.8,row_names_max_width=unit(7, "cm")),
  rnfn)

H3 <- renameHrows( scrna_evalPlot_silh(ov, agg.by = c("doubletmethod","sel","norm"), row_split = norm,
                                       heatmap_legend_param=list(direction="horizontal"),
                                       row_names_max_width=unit(7, "cm")), rnfn)
H4 <- renameHrows(
     evalHeatmap(ov, step="clustering", what=c("MI","min_pr"), anno_legend=FALSE, title=c("MI","Min precision"),
                 agg.by=c("doubletmethod","sel","norm"), row_split=norm,row_names_max_width=unit(7, "cm")) + 
    evalHeatmap(ov, step="clustering", what=c("ARI"), agg.by=c("doubletmethod","sel","norm"), 
                row_split=norm,filter=n_clus==true.nbClusts, title="ARI at true k", 
                anno_legend=FALSE, row_names_max_width=unit(7, "cm")),
  rnfn)
```
  
```{r, fig.width=9, fig.height=8.5}
plot_grid( grid.grabExpr(draw(H1, heatmap_legend_side="bottom")), 
           grid.grabExpr(draw(H2)), nrow=2, labels=LETTERS[1:2])
```
    
### Supplementary Figure `r getFigNb()`

Silhouette widths of the real subpopulations (**A**) and clustering accuracy (**B**) using different combinations of methods.


\newpage

# Supplementary Figure `r getFigNb(TRUE)`


```{r, fig.width=9, fig.height=8.5}
plot_grid( grid.grabExpr(draw(H3, heatmap_legend_side="bottom")), 
           grid.grabExpr(draw(H4)), nrow=2, labels=LETTERS[1:2])
```

### Supplementary Figure `r getFigNb()`

Silhouette widths of the real subpopulations (**A**) and clustering accuracy (**B**) using different combinations of methods.
