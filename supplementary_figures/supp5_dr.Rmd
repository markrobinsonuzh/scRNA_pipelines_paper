---
title: "Supplementary Figures relative to dimensionality reduction"
author: "Pierre-Luc Germain"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r, include=FALSE}
if(!exists('FIG_NB')){
  FIG_NB <- 0
  getFigNb <- function(increment=FALSE){
    if(increment) FIG_NB <<- FIG_NB + 1
    FIG_NB
  }
}
```

```{r}
suppressPackageStartupMessages({
  library(ggplot2)
  library(cowplot)
  library(ComplexHeatmap)
  library(reshape2)
  library(dplyr)
  library(pipeComp)
  library(viridis)
})
theme_set(theme_cowplot(font_size = 13))
source("../misc_functions.R")
```

# Supplementary Figure `r getFigNb(TRUE)`


```{r, fig.width=8, fig.height=8.5}
res <- readRDS("../data/clust_endSummary.rds")
res2 <- res[which(res$clust=="clust.seurat" & res$k==20 & res$dims>2),]
res2 <- res2[which(res2$dr=="seurat.pca" & res2$dataset!="Kumar"),]
res2$diff.nbClusters <- res2$nbClusters-truek[res2$dataset]
res3 <- aggregate(res2[,"diff.nbClusters"], by=res2[,c("dataset","dims","resolution")], FUN=mean)
colnames(res3)[4] <- "nb"
ll <- lapply(split(res3, res3$dataset), FUN=function(x){
  ggplot(x, aes(factor(dims), factor(resolution), fill=nb)) + stat_bin2d() + 
    scale_fill_viridis() + ylab("Resolution") + xlab("Number of dimensions") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
})
for(i in names(ll)) ll[[i]] <- ll[[i]] + ggtitle(i)
plot_grid(plotlist = ll, nrow=3)
```

### Supplementary Figure `r getFigNb()`
Mean difference between the number of detected clusters and the number of real subpopulations, depending on the resolution and number of dimensions used. Based on sctransform and seurat PCA. Increasing the number of dimensions tends to decrease the number of identified clusters, especially at resolutions around the default value.

\newpage

# Supplementary Figure `r getFigNb(TRUE)`


```{r, fig.width=8, fig.height=8.5}
library(viridis)
res <- readRDS("../data/clust_endSummary.rds")
res2 <- res[which(res$clust=="clust.seurat" & res$k==20 & res$dims>2 & res$resolution > 0.05 & res$resolution <= 1),]
res2 <- res2[which(res2$dr=="seurat.pca" & res2$dataset!="Kumar"),]
res3 <- aggregate(res2[,"ARI",drop=FALSE], by=res2[,c("dataset","dims","resolution")], FUN=mean)
ll <- lapply(split(res3, res3$dataset), FUN=function(x){
  ggplot(x, aes(factor(dims), factor(resolution), fill=ARI)) + stat_bin2d() + 
    scale_fill_viridis() + ylab("Resolution") + xlab("Number of dimensions") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
})
for(i in names(ll)) ll[[i]] <- ll[[i]] + ggtitle(i)
plot_grid(plotlist = ll, nrow=3)
```

### Supplementary Figure `r getFigNb()`
Adjusted Rand Index of clustering depending on the resolution and number of dimensions used. Based on sctransform and seurat PCA.



# Supplementary Figure `r getFigNb(TRUE)`

```{r, include=FALSE, eval=FALSE}
source(system.file("extdata", "scrna_alternatives.R", package="pipeComp"))
suppressPackageStartupMessages({
  library(SingleCellExperiment)
  library(Seurat)
  library(scater)
  library(intrinsicDimension)
})
datasets <- list.files("../datasets", full.names = TRUE)
names(datasets) <- gsub("\\..*", "", basename(datasets))
datasets <- lapply(datasets, readRDS)
datasets <- lapply(datasets, filt.mad)
datasets <- lapply(datasets, norm.seurat)
datasets <- lapply(datasets, sel.deviance)

met <- c("seurat.pca", "scran.denoisePCA", "scran.runPCA")
res <- list()
for(i in met) {
  res[[i]] <- list()
  print(i)
  a <- lapply(datasets, function(x) {
    switch(i,
           seurat.pca = seurat.pca(x),
           scran.denoisePCA = scran.denoisePCA(x),
           scran.runPCA = scran.runPCA(x))
  })
  x <- lapply(a, function(x) reducedDim(x, "PCA"))
  rm(a); gc()
  ks <- seq(5, 40, 5)
  for (d in names(datasets)) {
    res[[i]][[d]]$ndims <- c()
    res[[i]][[d]]$k <- c()
  }
  for (k in ks) {
    print(paste("k:", k))
    for (d in names(datasets)) {
      res[[i]][[d]]$ndims <- c(res[[i]][[d]]$ndims,
                               as.numeric(maxLikGlobalDimEst(x[[d]], k=k, unbiased=TRUE)))
      res[[i]][[d]]$k <- c(res[[i]][[d]]$k, k)
    }
  }
}
saveRDS(res, "../data/maxLikGlobal.rds")
```

```{r, fig.width=7, fig.height=5}
res <- readRDS("../data/maxLikGlobal.rds")
res <- dplyr::bind_rows(lapply(res$seurat.pca, as.data.frame), .id="dataset")
cols <- pipeComp::getQualitativePalette(9)
names(cols) <- unique(res$dataset)
ggplot(res, aes(k, ndims, colour=dataset)) + geom_point() + geom_line() + 
  scale_colour_manual(values=cols) + xlab("Number of nearest neighbors (k)") +
  ylab("Estimated dimensionality") + 
  ggtitle("intrinsicDimension::maxLikGlobalDimEst")
```

### Supplementary Figure `r getFigNb()`
Estimates of dimensionality by the `intrinsicDimension::maxLikGlobalDimEst` method using various 'reasonable' numbers of nearest neighbors (`k` parameter).

