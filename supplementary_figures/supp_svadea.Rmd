---
title: "Supplementary Figures relative to the SVA-DEA benchmark"
author: "Pierre-Luc Germain"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r, include=FALSE}
if(!exists('FIG_NB')){
  FIG_NB <- 0
  getFigNb <- function(increment=FALSE){
    if(increment) FIG_NB <<- FIG_NB + 1
    FIG_NB
  }
}

suppressPackageStartupMessages({
  library(ggplot2)
  library(cowplot)
  library(pipeComp)
  library(grid)
  library(ComplexHeatmap)
})
theme_set(theme_cowplot(font_size = 12))
res2 <- res1 <- res <- readRDS("../svadea/results/aggregated.rds")
res1$evaluation$dea <- lapply(res1$evaluation$dea, FUN=function(x){
  x[which(x$k==1),]
})
res2$evaluation$dea <- lapply(res2$evaluation$dea, FUN=function(x){
  x[which(x$k==2 | x$sva.method=="none"),]
})
```


# Fig S`r getFigNb(TRUE)`


```{r, fig.width=8.5, fig.height=8.5}
plot_grid(
  dea_evalPlot_curve(res1, agg.by=c("dea.method","filt","minCount"), shapeBy = "dea.method", colourBy = c("filter")) + ggtitle("Using 1 SV"),
  dea_evalPlot_curve(res1, agg.by=c("sva.method","filt","minCount"), shapeBy = "sva.method", colourBy = c("filter")) + ggtitle("Using 1 SV"),
  dea_evalPlot_curve(res2, agg.by=c("sva.method")) + ggtitle("Using 2 SVs"),
  nrow=3, labels=LETTERS[1:3]
)
```

### Fig S`r getFigNb()`
Accuracy of the differential expression analysis across combinations of: **A:** filters and DEA methods (using max 1 variable), **B:** filters and SVA methods (using max 1 variable), **C:** SVA methods (using 2 variables). In **C**, filled points indicate a nominal FDR below the observed FDR.


\newpage

# Fig S`r getFigNb(TRUE)`

```{r, fig.width=8, fig.height=8.5}
plot_grid(
  grid.grabExpr(draw(
    evalHeatmap(res1, what=c("logFC.pearson", "logFC.mad"), agg.by=c("sva.method","dea.method"), row_split="sva.method", font_factor=.9) +
      evalHeatmap(res1, what=c("TPR", "FDR"), agg.by=c("sva.method","dea.method"), row_split="sva.method", font_factor=.9,
                  filter=threshold==0.05)
  )),
  plotElapsed(res, agg.by=c("sva.method","dea.method")),
  nrow=2, labels=LETTERS[1:2]
)
```

### Fig S`r getFigNb()`
**A:** Accuracy of the estimated logFC (correlation and median absolute deviation from expected logFCs) and of the differential expression analysis (TPR stands for True Positive Rate, and FDR for False Discovery Rate) across the different combinations of SVA and DEA methods (using max 1 dimension). **B:** Running times of the different methods.

\newpage

