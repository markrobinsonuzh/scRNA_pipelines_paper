---
title: "Supplementary Figures relative to normalization"
author: "Pierre-Luc Germain"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r, include=FALSE}
if(!exists('FIG_NB')){
  FIG_NB <- 0
  getFigNb <- function(increment=FALSE){
    if(increment) FIG_NB <<- FIG_NB + 1
    FIG_NB
  }
}
```

```{r}
suppressPackageStartupMessages({
  library(ggplot2)
  library(cowplot)
  library(ComplexHeatmap)
  library(reshape2)
  library(dplyr)
})
suppressMessages(devtools::load_all("../../pipComp/"))
data(datasets)
source("../misc_functions.R")
```


# Supplementary Figure `r getFigNb(TRUE)`

```{r norm_r2, fig.width=8, fig.height=9}
res <- readRDS("../../resNew/norm_intermediateSummary.rds")
r2 <- res$dimreduction$PC.R2
r2$norm <- gsub("norm.","",reduceMethodNames(r2$method,3),fixed=T)
r2 <- r2[which(r2$dim <= 10),]
r2$R.on.Clusters <- sqrt(r2$value)
r3 <- cast2(r2, formula=norm~dataset, value.var="R.on.Clusters")
r2m <- dplyr::summarise(group_by(r2,dataset), meanR=mean(R.on.Clusters))
p1 <- ggplot(r2, aes(norm, R.on.Clusters, fill=norm)) + geom_violin() + facet_wrap(~dataset, nrow=1) + coord_flip() + theme(legend.position="none") + stat_summary(fun.y="mean", geom="point") + geom_hline(data=r2m, aes(yintercept=meanR)) + ggtitle("Proportion of the top dimensions explained by real clusters") + ylab("sqrt(R^2) of dimension ~ real cluster")

pc1.covar <- lapply( res$dimreduction$PC1.covar[2:3], FUN=function(x){
  x <- aggregate(x, by=list(reduceMethodNames(row.names(x), 3)), FUN=median)
  row.names(x) <- x[,1]
  x[,1] <- NULL
  x
})
names(pc1.covar) <- c("Correlation with log10-counts", "Correlation with nb features")
p2 <- grid.grabExpr(draw(chm(pc1.covar, sameScale=TRUE, scaleTitle="cor", value_format="%.2f", row_sortFn=median)))
plot_grid(p2, p1, labels=LETTERS[1:2], nrow=2)
```

### Supplementary Figure `r getFigNb()`
**A:** Proportion of the variance in the first 10 PCA components that is explained by real subpopulations. The square-root of R-squared values is plotted for ease of visualization.
**B:** Correlation of the first component with library size (left) or with the number of detected features (right).

\newpage

# Supplementary Figure `r getFigNb(TRUE)`

```{r norm_silwidth, fig.width=8, fig.height=7}
res <- readRDS("../../resNew/norm_intermediateSummary.rds")
sw <- res$dimreduction$clust.avg.silwidth[[1]]
hma <- HeatmapAnnotation(filtering=reduceMethodNames(colnames(sw),2), col=list(filtering=c(deffilter="#CC6677",lenientfilter="#4477AA",clustFilterStringent="#DDCC77")))
colnames(sw) <- gsub("norm.","",reduceMethodNames(colnames(sw), 3),fixed=T)
chm(list("Cluster mean silhouette width"=sw), scaleTitle="z-score", scale="row", row_ann=data.frame(meanSilWidth=rowMeans(sw), dataset=reduceMethodNames(row.names(sw),1)), show_row_names=FALSE, top_annotation=hma)
```

### Supplementary Figure `r getFigNb()`
Mean silhouette width of true subpopulations across the first 10 components with different normalization and scaling approaches.

\newpage

